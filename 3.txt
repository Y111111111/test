// ä¿®æ”¹åçš„ historyController.js - ä½¿ç”¨æœ€é«˜ä»·ä½œä¸ºæŠ˜çº¿å›¾æ•°æ®ç‚¹
const yahooFinanceService = require('../services/yahooFinanceService');

class HistoryController {
  // å¿«é€Ÿè·å–å›¾è¡¨æ•°æ® - ä½¿ç”¨æœ€é«˜ä»·
  static async getQuickChartData(req, res) {
    try {
      const { ticker, days } = req.params;
      
      if (![1, 3, 5].includes(parseInt(days))) {
        return res.status(400).json({
          success: false,
          error: 'å¤©æ•°åªæ”¯æŒ 1ã€3ã€5'
        });
      }

      console.log(`ğŸ“Š Yahoo Financeè¯·æ±‚æ•°æ®: ${ticker} ${days}å¤©`);

      // ä½¿ç”¨Yahoo Financeè·å–å†å²æ•°æ®
      const historyData = await yahooFinanceService.getHistoryByDays(ticker, parseInt(days));

      // å›¾è¡¨æ•°æ®æ ¼å¼ - ä½¿ç”¨æœ€é«˜ä»· (high) ä½œä¸ºä¸»è¦ä»·æ ¼ç‚¹
      const chartData = {
        labels: historyData.data.map(item => {
          const date = new Date(item.timestamp);
          return parseInt(days) === 1 
            ? date.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
              })
            : date.toLocaleDateString('zh-CN', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
        }),
        datasets: [{
          label: `${ticker} æœ€é«˜ä»·`,
          data: historyData.data.map(item => item.high), // ä½¿ç”¨æœ€é«˜ä»·
          borderColor: 'rgb(220, 38, 127)', // ç²‰çº¢è‰²è¡¨ç¤ºæœ€é«˜ä»·
          backgroundColor: 'rgba(220, 38, 127, 0.1)',
          tension: 0.1,
          pointRadius: 1, // å°çš„æ•°æ®ç‚¹
          pointHoverRadius: 4
        }]
      };

      // åŸºäºæœ€é«˜ä»·çš„ç»Ÿè®¡ä¿¡æ¯
      const highPrices = historyData.data.map(item => item.high);
      const lowPrices = historyData.data.map(item => item.low);
      const closePrices = historyData.data.map(item => item.close);
      
      const stats = {
        // åŸºäºæœ€é«˜ä»·çš„ç»Ÿè®¡
        currentHighPrice: highPrices[highPrices.length - 1],
        peakPrice: Math.max(...highPrices), // æœŸé—´å†…çš„æœ€é«˜ç‚¹
        lowestHigh: Math.min(...highPrices), // æœ€é«˜ä»·ä¸­çš„æœ€ä½å€¼
        
        // ä¼ ç»Ÿç»Ÿè®¡ä¿¡æ¯
        currentClosePrice: closePrices[closePrices.length - 1],
        highestPrice: Math.max(...highPrices),
        lowestPrice: Math.min(...lowPrices),
        
        // ä»·æ ¼å˜åŒ– (åŸºäºæ”¶ç›˜ä»·)
        priceChange: closePrices[closePrices.length - 1] - closePrices[0],
        priceChangePercent: ((closePrices[closePrices.length - 1] - closePrices[0]) / closePrices[0] * 100).toFixed(2),
        
        // æœ€é«˜ä»·å˜åŒ–
        highPriceChange: highPrices[highPrices.length - 1] - highPrices[0],
        highPriceChangePercent: ((highPrices[highPrices.length - 1] - highPrices[0]) / highPrices[0] * 100).toFixed(2)
      };

      // ä¸ºå‰ç«¯æä¾›å¤šç§å›¾è¡¨æ•°æ®é€‰é¡¹
      const multiDatasets = {
        // åªæ˜¾ç¤ºæœ€é«˜ä»·çš„æ•°æ®é›† (ä¸»è¦)
        highOnly: {
          labels: chartData.labels,
          datasets: [{
            label: `${ticker} æœ€é«˜ä»·`,
            data: historyData.data.map(item => item.high),
            borderColor: 'rgb(220, 38, 127)',
            backgroundColor: 'rgba(220, 38, 127, 0.1)',
            tension: 0.1
          }]
        },
        
        // åŒ…å«æœ€é«˜ä»·ã€æœ€ä½ä»·ã€æ”¶ç›˜ä»·çš„å®Œæ•´æ•°æ®é›†
        complete: {
          labels: chartData.labels,
          datasets: [
            {
              label: `${ticker} æœ€é«˜ä»·`,
              data: historyData.data.map(item => item.high),
              borderColor: 'rgb(220, 38, 127)',
              backgroundColor: 'rgba(220, 38, 127, 0.1)',
              tension: 0.1
            },
            {
              label: `${ticker} æ”¶ç›˜ä»·`,
              data: historyData.data.map(item => item.close),
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.1
            },
            {
              label: `${ticker} æœ€ä½ä»·`,
              data: historyData.data.map(item => item.low),
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.1
            }
          ]
        }
      };

      res.json({
        success: true,
        data: {
          ticker: ticker.toUpperCase(),
          period: `${days}å¤©`,
          
          // ä¸»è¦å›¾è¡¨æ•°æ® (æœ€é«˜ä»·)
          chartData: chartData,
          
          // å¤šç§å›¾è¡¨é€‰é¡¹
          chartOptions: multiDatasets,
          
          // åŸå§‹æ•°æ® (åŒ…å«æ‰€æœ‰OHLCVæ•°æ®)
          rawData: historyData.data,
          
          // ç»Ÿè®¡ä¿¡æ¯
          stats: stats,
          
          // æ•°æ®è´¨é‡ä¿¡æ¯
          quality: historyData.quality,
          
          source: historyData.source,
          provider: 'Yahoo Finance (å…è´¹æ— é™åˆ¶)',
          
          // å‰ç«¯ä½¿ç”¨æç¤º
          usage: {
            primary: "ä½¿ç”¨ chartData è·å–åŸºäºæœ€é«˜ä»·çš„æŠ˜çº¿å›¾",
            alternative: "ä½¿ç”¨ chartOptions.highOnly æˆ– chartOptions.complete",
            dataPoints: historyData.data.length,
            timeRange: `${historyData.quality?.timeRange || 'æœªçŸ¥'}`
          }
        }
      });

    } catch (error) {
      console.error('âŒ Yahoo Financeè·å–æ•°æ®å¤±è´¥:', error.message);
      
      res.status(503).json({
        success: false,
        error: 'Yahoo Finance APIä¸å¯ç”¨',
        details: error.message,
        suggestion: 'è¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®'
      });
    }
  }

  // æœç´¢è‚¡ç¥¨ - ä½¿ç”¨Yahoo Finance
  static async searchStocks(req, res) {
    try {
      const { q } = req.query;
      
      if (!q || q.trim().length === 0) {
        return res.status(400).json({
          success: false,
          error: 'è¯·æä¾›æœç´¢å…³é”®è¯'
        });
      }

      console.log(`ğŸ” Yahoo Financeæœç´¢: ${q}`);
      const searchResults = await yahooFinanceService.searchSymbols(q.trim());

      res.json({
        success: true,
        data: {
          query: q.trim(),
          results: searchResults,
          count: searchResults.length,
          provider: 'Yahoo Finance'
        }
      });

    } catch (error) {
      console.error('âŒ Yahoo Financeæœç´¢å¤±è´¥:', error.message);
      res.status(503).json({
        success: false,
        error: 'Yahoo Financeæœç´¢APIä¸å¯ç”¨',
        details: error.message
      });
    }
  }

  // è·å–è‚¡ç¥¨è¯¦ç»†ä¿¡æ¯ - ä½¿ç”¨Yahoo Finance
  static async getStockInfo(req, res) {
    try {
      const { ticker } = req.params;

      console.log(`ğŸ¢ Yahoo Financeè·å–è‚¡ç¥¨ä¿¡æ¯: ${ticker}`);
      const stockInfo = await yahooFinanceService.getCompanyOverview(ticker);

      res.json({
        success: true,
        data: {
          ...stockInfo,
          provider: 'Yahoo Finance'
        }
      });

    } catch (error) {
      console.error('âŒ Yahoo Financeè·å–è‚¡ç¥¨ä¿¡æ¯å¤±è´¥:', error.message);
      res.status(503).json({
        success: false,
        error: 'Yahoo Financeè‚¡ç¥¨ä¿¡æ¯APIä¸å¯ç”¨',
        details: error.message
      });
    }
  }

  // è·å–å®æ—¶ä»·æ ¼ - ä½¿ç”¨Yahoo Finance
  static async getCurrentPrice(req, res) {
    try {
      const { ticker } = req.params;
      
      console.log(`ğŸ’° Yahoo Financeè·å–å®æ—¶ä»·æ ¼: ${ticker}`);
      const priceData = await yahooFinanceService.getCurrentPrice(ticker);

      res.json({
        success: true,
        data: {
          symbol: ticker.toUpperCase(),
          ...priceData,
          timestamp: new Date(),
          provider: 'Yahoo Finance'
        }
      });
    } catch (error) {
      console.error('âŒ Yahoo Financeè·å–å®æ—¶ä»·æ ¼å¤±è´¥:', error.message);
      res.status(503).json({
        success: false,
        error: 'Yahoo Financeä»·æ ¼APIä¸å¯ç”¨',
        details: error.message
      });
    }
  }

  // è·å–è¶‹åŠ¿è‚¡ç¥¨ - æ–°å¢åŠŸèƒ½
  static async getTrendingStocks(req, res) {
    try {
      const { region = 'US', count = 10 } = req.query;
      
      console.log(`ğŸ“ˆ Yahoo Financeè·å–è¶‹åŠ¿è‚¡ç¥¨: ${region}`);
      const trendingStocks = await yahooFinanceService.getTrendingSymbols(region, parseInt(count));

      res.json({
        success: true,
        data: {
          region: region,
          trending: trendingStocks,
          count: trendingStocks.length,
          provider: 'Yahoo Finance'
        }
      });

    } catch (error) {
      console.error('âŒ Yahoo Financeè·å–è¶‹åŠ¿å¤±è´¥:', error.message);
      res.status(503).json({
        success: false,
        error: 'Yahoo Financeè¶‹åŠ¿APIä¸å¯ç”¨',
        details: error.message
      });
    }
  }

  // è·å–è‚¡ç¥¨æ¨è - æ–°å¢åŠŸèƒ½
  static async getRecommendations(req, res) {
    try {
      const { ticker } = req.params;
      
      console.log(`ğŸ’¡ Yahoo Financeè·å–æ¨è: ${ticker}`);
      const recommendations = await yahooFinanceService.getRecommendations(ticker);

      res.json({
        success: true,
        data: {
          symbol: ticker.toUpperCase(),
          recommendations: recommendations,
          provider: 'Yahoo Finance'
        }
      });

    } catch (error) {
      console.error('âŒ Yahoo Financeè·å–æ¨èå¤±è´¥:', error.message);
      res.status(503).json({
        success: false,
        error: 'Yahoo Financeæ¨èAPIä¸å¯ç”¨',
        details: error.message
      });
    }
  }

  // æ·»åŠ è‚¡ç¥¨åˆ°æ•°æ®åº“ - ä½¿ç”¨Yahoo FinanceéªŒè¯
  static async addStock(req, res) {
    try {
      const { ticker, fetchData = false } = req.body;
      
      if (!ticker) {
        return res.status(400).json({
          success: false,
          error: 'è¯·æä¾›è‚¡ç¥¨ä»£ç '
        });
      }

      // ä½¿ç”¨Yahoo FinanceéªŒè¯è‚¡ç¥¨ä»£ç 
      console.log(`âœ… Yahoo FinanceéªŒè¯è‚¡ç¥¨ä»£ç : ${ticker}`);
      const stockInfo = await yahooFinanceService.getCompanyOverview(ticker);

      res.status(201).json({
        success: true,
        data: {
          ticker: ticker.toUpperCase(),
          info: stockInfo,
          message: 'è‚¡ç¥¨ä»£ç éªŒè¯æˆåŠŸ',
          provider: 'Yahoo Finance'
        }
      });

    } catch (error) {
      console.error('âŒ Yahoo FinanceéªŒè¯è‚¡ç¥¨ä»£ç å¤±è´¥:', error.message);
      res.status(400).json({
        success: false,
        error: 'æ— æ³•éªŒè¯è‚¡ç¥¨ä»£ç ',
        details: error.message
      });
    }
  }

  // è·å–è‚¡ç¥¨å†å²æ•°æ® - æ•°æ®åº“ç‰ˆæœ¬
  static async getStockHistory(req, res) {
    try {
      const { id } = req.params;
      const { days = 1 } = req.query;
      
      res.status(501).json({
        success: false,
        error: 'éœ€è¦å®Œæ•´çš„æ•°æ®åº“é›†æˆæ¥æ”¯æŒæ­¤åŠŸèƒ½',
        message: 'è¯·ä½¿ç”¨ /api/quick-chart/:ticker/:days è·å–å†å²æ•°æ®',
        suggestion: 'å½“å‰ä½¿ç”¨Yahoo Financeæä¾›å…è´¹æ— é™åˆ¶çš„è‚¡ç¥¨æ•°æ®'
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }
}

module.exports = HistoryController;